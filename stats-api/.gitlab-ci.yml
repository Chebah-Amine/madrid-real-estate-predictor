image: python:3.11

services:
  - name: mongo:latest
    alias: mongodb

variables:
  MONGO_INITDB_ROOT_USERNAME: admin
  MONGO_INITDB_ROOT_PASSWORD: ChangeMe
  MONGODB_HOST: mongodb
  MONGODB_PORT: 27017
  MONGODB_USERNAME: admin
  MONGODB_PASSWORD: ChangeMe
  MONGODB_DB: sales_test
  PYTHONPATH: "/psid/app"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip

before_script:
  - python -m pip install --upgrade pip
  - pip install -r ./docker/requirements.txt --cache-dir .cache/pip

stages:
  - security_scan
  - lint
  - tests
  - sonarqube

security_scan:
  stage: security_scan
  script:
    - safety check --full-report
  allow_failure: false

lint:
  stage: lint
  script:
    - echo "Vérification de la qualité du code..."
    - flake8 .
  allow_failure: false

tests:
  stage: tests
  script:
    - echo "Lancement des tests..."
    - pip install coverage
    - coverage run --omit='app/test/*' -m unittest discover -s app/test
    - coverage xml -o coverage.xml
    - coverage report
  artifacts:
    paths:
      - coverage.xml
  allow_failure: false

sonarcloud-check:
  stage: sonarqube
  needs:
   - job: tests
     artifacts: true
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner


